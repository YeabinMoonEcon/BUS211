---
title: "Lecture 9"
author: "Yeabin"
date: "2022-09-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages}
library(tidyverse)
library(ggrepel)
```

#### Layer color and text
Letâ€™s work through an example where we use manually specified colors both for emphasis and because of their social meaning. We will build up a plot of data about the 2016 US general election used in the last lecture.

```{r}
setwd("~/Documents/ibs_course/BUS240/data")
load("county_data.rda")
party_colors <- c("#2E74C0", "#CB454A") # Democrat Blue and Republican Red
```

Note this variables:
```{r}
# id. FIPS State and County code (character)
# pop. Population, 2014 estimate
# flipped Did the area flip parties from 2012 to 2016
# black. Black alone, percent, 2013
county_data %>% select(id, pop, flipped, black) %>% sample_n(8)
```
```{r}
p0 <- ggplot(data = subset(county_data,
                           flipped == "No"),
             mapping = aes(x = pop,
                           y = black/100))
p0 + geom_point(color = "gray50") 
p0 + geom_point(alpha = 0.15, color = "gray50") 
p0 + geom_point(alpha = 0.15, color = "gray50") + scale_x_log10(labels=scales::comma) 
```
Now consider
```{r}
#partywinner16. Winning party, 2016 Presidental Election.
county_data %>% select(id, partywinner16) %>% sample_n(8)
# save previous results in p1
p1 <- p0 + geom_point(alpha = 0.15, color = "gray50") + scale_x_log10(labels=scales::comma) 
p2 <- p1 + geom_point(data = subset(county_data,
                                    flipped == "Yes"),
                      mapping = aes(x = pop, y = black/100,
                                    color = partywinner16)) +
  scale_color_manual(values = party_colors)
p2
```

Clean up the labels
```{r}
p3 <- p2 + scale_y_continuous(labels=scales::percent) +
    labs(color = "County flipped to ... ",
         x = "County Population (log scale)",
         y = "Percent Black Population",
         title = "Flipped counties, 2016",
         caption = "Counties in gray did not flip.")

p3
```

Last, add a third layer using geom_text_repel() function. Once again we supply a set of instructions to subset the data for this text layer. We are interested in the flipped counties that have with a relatively high percentage of African-American residents.
```{r}
p4 <- p3 + geom_text_repel(data = subset(county_data,
                                      flipped == "Yes" &
                                      black  > 25),
                           mapping = aes(x = pop,
                                   y = black/100,
                                   label = state), size = 2)
p4
p4 + theme_minimal() + theme(legend.position="top")
```

### create the scatter plot with the counties in which the number of population having less than 75 % of data points (the third quartile) only

```{r}
population <- county_data$pop 
quantile(population) 
cutoff <- quantile(population)[4]
```

```{r}
p0 <- ggplot(data = subset(county_data,
                           flipped == "No" & pop < cutoff),
             mapping = aes(x = pop,
                           y = black/100))
p1 <- p0 + geom_point(alpha = 0.15, color = "gray50") 
p1
```


### Scale is necessary?
```{r}
p2 <- p1 + geom_point(data = subset(county_data,
                                    flipped == "Yes" & pop < cutoff),
                      mapping = aes(x = pop, y = black/100,
                                    color = partywinner16)) +
 scale_color_manual(values = party_colors) 

p3 <- p2 + scale_y_continuous(labels=scales::percent) +
    labs(color = "County flipped to ... ",
         x = "County Population",
         y = "Percent Black Population",
         title = "Flipped counties, 2016",
         caption = "Counties in gray did not flip.") 
p3
```

### plot the text labels for the counties flipped to Democrat
```{r}
p4 <- p3 + geom_text_repel(data = subset(county_data,
                                         flipped == "Yes" & pop < cutoff & partywinner16  ==  "Democrat"),
                           mapping = aes(x = pop, y = black/100,
                                         label=paste(name,",",state)), size = 2)
p4 + theme_minimal() + theme(legend.position="top")

```

Scale vs. Subsetting?