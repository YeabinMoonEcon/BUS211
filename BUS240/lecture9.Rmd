---
title: "Lecture 9"
author: "Yeabin"
date: "2022-09-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages}
library(tidyverse)
library(ggrepel)
```

## Lecture 9

### 9.1 Adding general details

We have learned the fundamental functionalities of ggplot. Let's refine the plots.

```{r}
setwd("~/Documents/ibs_course/BUS240/data")
load("asasec.rda")
head(asasec)

```
This is some data on membership over time in special-interest sections of the American Sociological Association.

In this dataset, we have membership data for each section over a ten year period.

Let’s look at the relationship between section membership and section revenues for a single year, 2014.

```{r}
p <- ggplot(data = subset(asasec, Year == 2014),
            mapping = aes(x = Members, y = Revenues, label = Sname))
p + geom_point() + geom_smooth()
```

This is our basic scatterplot-and-smoother graph. The defalut geom_smooth method is loess (local weighted regression).

To refine it, let’s begin by identifying some outliers, switch from loess to OLS, and introduce a third variable, Journal, into the aes() which is inside geom_point
```{r}
unique(asasec$Journal)
```

```{r}
p <- ggplot(data = subset(asasec, Year == 2014),
            mapping = aes(x = Members, y = Revenues, label = Sname))

p + geom_point(mapping = aes(color = Journal)) +
    geom_smooth(method = "lm")
```

Now we can add some text labels. Let's build it additively.
```{r}
p0 <- ggplot(data = subset(asasec, Year == 2014),
             mapping = aes(x = Members, y = Revenues, label = Sname))

p1 <- p0 + geom_smooth(method = "lm", se = FALSE, color = "gray80") +
    geom_point(mapping = aes(color = Journal)) 
p1
p2 <- p1 + geom_text_repel(data=subset(asasec,
                                       Year == 2014 & Revenues > 7000),
                           size = 2)
p2
```
Continuing with the p2 object still, we can label the axes and scales. We also add a title and move the legend to make better use of the space in the plot.
```{r}
p3 <- p2 + labs(x="Membership",
        y="Revenues",
        color = "Section has own Journal",
        title = "ASA Sections",
        subtitle = "2014 Calendar year.",
        caption = "Source: ASA annual report.")
p3
p4 <- p3 + scale_y_continuous(labels = scales::dollar) +
     theme(legend.position = "bottom")
p4
```

### 9.2 Color

Consider: <b>ordered</b>  vs. <b>unordered</b> categorical variable. What's the examples?

There are many ways to color your figures, so make sure that the following example is just one of them. We use the RColorBrewer package to make a wide range of named color palettes available. Together with ggplot, you access these colors by specifying the scale_color_brewer() or scale_fill_brewer() functions, depending on the aesthetic you are mapping. 

Let's use organdata we used before.
```{r}
setwd("~/Documents/ibs_course/BUS240/data")
load("organdata.rda")
head(organdata)
```

```{r}
p <- ggplot(data = organdata,
            mapping = aes(x = roads, y = donors, color = world))
p + geom_point(size = 2)
p + geom_point(size = 2) + scale_color_brewer(palette = "Set2") 
p + geom_point(size = 2) + scale_color_brewer(palette = "Set2") +
  theme(legend.position = "top")
p + geom_point(size = 2) + scale_color_brewer(palette = "Pastel2") +
  theme(legend.position = "top")
p + geom_point(size = 2) + scale_color_brewer(palette = "Dark2") +
  theme(legend.position = "top")
```

You can also specify colors manually, via scale_color_manual() or scale_fill_manual(). These functions take a value argument that can be specified as vector of color names or color values that R knows about.

R knows many color names (like red, and green, and cornflowerblue. Try demo('colors') for an overview. 

Alternatively, color values can be specified via their hexadecimal RGB value. This is a way of encoding color values in the RGB colorspace, where each channel can take a value from 0 to 255 like this. A color hex value begins with a hash or pound character, #, followed by three pairs of hexadecimal or “hex” numbers. Hex values are in Base 16, with the first six letters of the alphabet standing for the numbers 10 to 15. This allows a two-character hex number to range from 0 to 255. You read them as #rrggbb, where rr is the two-digit hex code for the red channel, gg for the green channel, and bb for the blue channel. So #CC55DD translates in decimal to CC = 204 (red), 55 = 85 (green), and DD = 221 (blue). It gives a strong pink color.



Going back to our ASA Membership plot, for example, we can manually introduce a palette  that’s friendly to color-blind viewers.
```{r}
cb_palette <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
                "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

p4 + scale_color_manual(values = cb_palette) 
```

The ability to manually specify colors can be useful when the meaning of a category itself has a strong color association. For example, blue and red for political parties in U.S. What else?

#### Layer color and text
Let’s work through an example where we use manually specified colors both for emphasis and because of their social meaning. We will build up a plot of data about the 2016 US general election used in the last lecture.

```{r}
setwd("~/Documents/ibs_course/BUS240/data")
load("county_data.rda")
party_colors <- c("#2E74C0", "#CB454A") # Democrat Blue and Republican Red
```

Note this variables:
```{r}
# id. FIPS State and County code (character)
# pop. Population, 2014 estimate
# flipped Did the area flip parties from 2012 to 2016
# black. Black alone, percent, 2013
county_data %>% select(id, pop, flipped, black) %>% sample_n(8)
```
```{r}
p0 <- ggplot(data = subset(county_data,
                           flipped == "No"),
             mapping = aes(x = pop,
                           y = black/100))
p0 + geom_point(color = "gray50") 
p0 + geom_point(alpha = 0.15, color = "gray50") 
p0 + geom_point(alpha = 0.15, color = "gray50") + scale_x_log10(labels=scales::comma) 
```
Now consider
```{r}
#partywinner16. Winning party, 2016 Presidental Election.
county_data %>% select(id, partywinner16) %>% sample_n(8)
# save previous results in p1
p1 <- p0 + geom_point(alpha = 0.15, color = "gray50") + scale_x_log10(labels=scales::comma) 
p2 <- p1 + geom_point(data = subset(county_data,
                                    flipped == "Yes"),
                      mapping = aes(x = pop, y = black/100,
                                    color = partywinner16)) +
  scale_color_manual(values = party_colors)
p2
```

Clean up the labels
```{r}
p3 <- p2 + scale_y_continuous(labels=scales::percent) +
    labs(color = "County flipped to ... ",
         x = "County Population (log scale)",
         y = "Percent Black Population",
         title = "Flipped counties, 2016",
         caption = "Counties in gray did not flip.")

p3
```

Last, add a third layer using geom_text_repel() function. Once again we supply a set of instructions to subset the data for this text layer. We are interested in the flipped counties that have with a relatively high percentage of African-American residents.
```{r}
p4 <- p3 + geom_text_repel(data = subset(county_data,
                                      flipped == "Yes" &
                                      black  > 25),
                           mapping = aes(x = pop,
                                   y = black/100,
                                   label = state), size = 2)
p4
p4 + theme_minimal() + theme(legend.position="top")
```

<b>Consider how much information we use from data to picture this.</b>

#### Theme
Need more style?
```{r}
theme_set(theme_bw())
p4 + theme(legend.position="top")
theme_set(theme_dark())
p4 + theme(legend.position="top")
```

Professional touch (not artistic)? Use ggthemes.
```{r}
library(ggthemes)
theme_set(theme_economist())
p4 + theme(legend.position="top")

theme_set(theme_wsj())

p4 + theme(plot.title = element_text(size = rel(0.6)),
           legend.title = element_text(size = rel(0.35)),
           plot.caption = element_text(size = rel(0.35)),
           legend.position = "top")
```

### 9.3 Others

#### Y axes on both sides
```{r}
library(cowplot)
theme_set(theme_minimal())
setwd("~/Documents/ibs_course/BUS240/data")
load("fredts.rda")
head(fredts)

fredts_m <- fredts %>% select(date, sp500_i, monbase_i) %>%
    gather(key = series, value = score, sp500_i:monbase_i)

head(fredts_m)

p <- ggplot(data = fredts_m,
            mapping = aes(x = date, y = score,
                          group = series,
                          color = series))
p1 <- p + geom_line() + theme(legend.position = "top") +
    labs(x = "Date",
         y = "Index",
         color = "Series")
p1
p <- ggplot(data = fredts,
            mapping = aes(x = date, y = sp500_i - monbase_i))
p2 <- p + geom_line() +
    labs(x = "Date",
         y = "Difference")
p2
cowplot::plot_grid(p1, p2, nrow = 2, rel_heights = c(0.75, 0.25), align = "v")
```